name: Performance

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  pull-requests: write

jobs:
  performance:
    name: Performance Comparison
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          path: pr

      - name: Checkout master branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          # TODO: replace with "master"
          ref: 5bc4ecd51ee7ab5d636c78b782f79d55783908f1
          path: master

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.27.0
          run_install: false

      - name: Use Node.js 22.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22.18.0
          cache: "pnpm"
          cache-dependency-path: pr/pnpm-lock.yaml

      - name: Install dependencies (PR)
        run: pnpm install --frozen-lockfile
        working-directory: pr

      - name: Install dependencies (master)
        run: pnpm install --frozen-lockfile
        working-directory: master

      - name: Run performance measurement (PR)
        id: perf-pr
        working-directory: pr
        # TODO: Replace with real performance test
        run: |
          METRICS=$(node --experimental-strip-types --no-warnings << 'EOF'
          import { createMockTrace } from './test/performance/src/createMockTrace.ts';
          import { extractMetrics } from './test/performance/src/extractMetrics.ts';

          const trace = createMockTrace({ eventCount: 20 });
          const metrics = extractMetrics(trace);
          console.log(JSON.stringify(metrics));
          EOF
          )
          echo "metrics=$METRICS" >> $GITHUB_OUTPUT

      - name: Run performance measurement (master)
        id: perf-master
        working-directory: master
        # TODO: Replace with real performance test
        run: |
          METRICS=$(node --experimental-strip-types --no-warnings << 'EOF'
          import { createMockTrace } from './test/performance/src/createMockTrace.ts';
          import { extractMetrics } from './test/performance/src/extractMetrics.ts';

          const trace = createMockTrace({ eventCount: 20 });
          const metrics = extractMetrics(trace);
          console.log(JSON.stringify(metrics));
          EOF
          )
          echo "metrics=$METRICS" >> $GITHUB_OUTPUT

      - name: Compare and comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prMetrics = JSON.parse('${{ steps.perf-pr.outputs.metrics }}');
            const masterMetrics = JSON.parse('${{ steps.perf-master.outputs.metrics }}');

            const prDuration = prMetrics.totalDuration;
            const masterDuration = masterMetrics.totalDuration;
            const diff = prDuration - masterDuration;
            const diffPercent = ((diff / masterDuration) * 100).toFixed(2);
            const emoji = diff > 0 ? 'ðŸ”º' : diff < 0 ? 'ðŸ”½' : 'âž¡ï¸';

            const body = `## Performance Comparison

            | Metric | Master | PR | Diff |
            |--------|--------|-----|------|
            | Total Duration (Î¼s) | ${masterDuration.toLocaleString()} | ${prDuration.toLocaleString()} | ${emoji} ${diff > 0 ? '+' : ''}${diff.toLocaleString()} (${diffPercent}%) |
            | Event Count | ${masterMetrics.eventCount} | ${prMetrics.eventCount} | ${prMetrics.eventCount - masterMetrics.eventCount} |

            <details>
            <summary>Duration by Event Type</summary>

            | Event | Master (Î¼s) | PR (Î¼s) |
            |-------|-------------|---------|
            ${Object.keys({ ...masterMetrics.durationByEvent, ...prMetrics.durationByEvent })
              .map(event => `| ${event} | ${(masterMetrics.durationByEvent[event] || 0).toLocaleString()} | ${(prMetrics.durationByEvent[event] || 0).toLocaleString()} |`)
              .join('\n')}

            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## Performance Comparison')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
