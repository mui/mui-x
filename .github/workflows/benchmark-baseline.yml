name: Benchmark Baseline

on:
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  benchmark:
    name: Store Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.27.0
          run_install: false

      - name: Use Node.js 22.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22.18.0
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm release:build

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run performance benchmarks
        run: pnpm -r run benchmark

      - name: Checkout data repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: mnajdova/performance-benchmark-data
          path: data-repo
          token: ${{ secrets.BENCHMARK_DATA_TOKEN }}

      - name: Get commit month
        id: meta
        run: echo "month=$(git log -1 --format=%cd --date=format:%Y-%m ${{ github.sha }})" >> $GITHUB_OUTPUT

      - name: Store results
        env:
          SHA: ${{ github.sha }}
          MONTH: ${{ steps.meta.outputs.month }}
        run: |
          RESULTS_DIR=test/benchmark-tool/benchmarks
          COMMITS_DIR=data-repo/benchmarks/commits/$SHA

          # Copy per-SHA files (one file per benchmark, unmodified)
          mkdir -p "$COMMITS_DIR"
          cp $RESULTS_DIR/*.json "$COMMITS_DIR/"

          # Append to monthly JSONL (one file per benchmark type)
          for f in $RESULTS_DIR/*.json; do
            NAME=$(basename "$f" .json)
            MONTHLY_DIR="data-repo/benchmarks/monthly/$NAME"
            mkdir -p "$MONTHLY_DIR"

            # Extract total duration and append as JSONL line
            DUR=$(node -e "
              const t = require('./$f');
              let d=0; for(const e of t.traceEvents||[]){if(e.ph==='X')d+=e.dur||0;}
              process.stdout.write(String(d));
            ")
            echo "{\"commit\":\"$SHA\",\"date\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"duration\":$DUR}" >> "$MONTHLY_DIR/$MONTH.jsonl"
          done

      - name: Commit and push
        working-directory: data-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add benchmarks/
          git commit -m "Add benchmarks for ${{ github.sha }}"
          git push
